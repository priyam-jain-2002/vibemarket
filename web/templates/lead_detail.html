{% extends "base.html" %}

{% block title %}{{ lead.name }} - Vibe-Leads{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Button -->
    <div>
        <a href="/leads" class="text-blue-600 hover:underline">‚Üê Back to Leads</a>
    </div>

    <!-- Lead Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <!-- Score Badge -->
                {% if lead.score %}
                <span class="score-badge score-{{ lead.score.lower().replace('+', '-plus') }} text-lg">
                    {{ lead.score }}
                </span>
                {% else %}
                <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded text-sm">
                    Not Analyzed
                </span>
                {% endif %}

                <!-- Name & Title -->
                <h1 class="text-3xl font-bold text-gray-900 mt-4">{{ lead.name }}</h1>

                {% if lead.title or lead.company %}
                <p class="text-xl text-gray-600 mt-1">
                    {% if lead.title %}{{ lead.title }}{% endif %}
                    {% if lead.company %}
                        {% if lead.title %} ‚Ä¢ {% endif %}
                        {{ lead.company }}
                    {% endif %}
                </p>
                {% endif %}

                <!-- Meta Info -->
                <div class="flex flex-wrap items-center gap-4 mt-4 text-sm text-gray-600">
                    <span>üìç {{ lead.source.capitalize() }}</span>
                    <span>üìÖ {{ lead.created_at.strftime('%b %d, %Y %H:%M') }}</span>
                    {% if lead.url %}
                    <a href="{{ lead.url }}" target="_blank" class="text-blue-600 hover:underline">
                        üîó Source URL
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col space-y-2">
                {% if not lead.score %}
                <button
                    hx-post="/leads/{{ lead.id }}/analyze"
                    hx-swap="none"
                    hx-on::after-request="window.location.reload()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                    ü§ñ Analyze with AI
                </button>
                {% endif %}

                {% if lead.score in ['A+', 'A'] and lead.outreach_message %}
                <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium">
                    üìß Send Email
                </button>
                {% endif %}

                <!-- Status Dropdown -->
                <form hx-post="/leads/{{ lead.id }}/status"
                      hx-swap="none"
                      hx-on::after-request="window.location.reload()">
                    <select name="status"
                            onchange="this.form.submit()"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full">
                        <option value="new" {% if lead.status == 'new' %}selected{% endif %}>New</option>
                        <option value="analyzed" {% if lead.status == 'analyzed' %}selected{% endif %}>Analyzed</option>
                        <option value="contacted" {% if lead.status == 'contacted' %}selected{% endif %}>Contacted</option>
                        <option value="replied" {% if lead.status == 'replied' %}selected{% endif %}>Replied</option>
                        <option value="won" {% if lead.status == 'won' %}selected{% endif %}>Won</option>
                        <option value="lost" {% if lead.status == 'lost' %}selected{% endif %}>Lost</option>
                        <option value="archived" {% if lead.status == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                </form>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (2/3) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Original Content -->
            {% if lead.content %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Original Post</h2>
                <div class="p-4 bg-gray-50 rounded-md border-l-4 border-blue-500">
                    <p class="text-gray-800 whitespace-pre-wrap">{{ lead.content }}</p>
                </div>
            </div>
            {% endif %}

            <!-- AI Analysis -->
            {% if lead.score %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">AI Analysis</h2>

                <div class="space-y-4">
                    <!-- Pain Points -->
                    {% if lead.pain_points %}
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Pain Points</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for pain in lead.pain_points %}
                            <span class="px-3 py-1 bg-red-50 text-red-700 rounded-full text-sm">
                                {{ pain }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Analysis Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        {% if lead.urgency %}
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700">Urgency</h3>
                            <p class="text-lg font-bold
                                {% if lead.urgency == 'HIGH' %}text-red-600
                                {% elif lead.urgency == 'MEDIUM' %}text-yellow-600
                                {% else %}text-gray-600{% endif %}">
                                {{ lead.urgency }}
                            </p>
                        </div>
                        {% endif %}

                        {% if lead.authority %}
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700">Authority</h3>
                            <p class="text-lg font-bold text-gray-900">{{ lead.authority.replace('_', ' ').title() }}</p>
                        </div>
                        {% endif %}

                        {% if lead.specificity_score %}
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700">Specificity</h3>
                            <p class="text-lg font-bold text-gray-900">{{ lead.specificity_score }}/10</p>
                        </div>
                        {% endif %}

                        {% if lead.pain_clarity %}
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700">Pain Clarity</h3>
                            <p class="text-lg font-bold text-gray-900">{{ lead.pain_clarity }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Generated Message -->
            {% if lead.outreach_message %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Outreach Message</h2>
                <div class="p-4 bg-green-50 rounded-md border-l-4 border-green-500">
                    <p class="text-gray-800 whitespace-pre-wrap">{{ lead.outreach_message }}</p>
                </div>

                <div class="mt-4 flex space-x-2">
                    <button onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.querySelector('p').textContent)"
                            class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                        üìã Copy
                    </button>
                    <button class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                        üìß Send Email
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Email History -->
            {% if emails %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Email History</h2>
                <div class="space-y-4">
                    {% for email in emails %}
                    <div class="p-4 bg-gray-50 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-900">{{ email.subject }}</h3>
                            <span class="text-sm text-gray-600">{{ email.sent_at.strftime('%b %d, %Y %H:%M') }}</span>
                        </div>
                        <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ email.body[:200] }}...</p>
                        {% if email.replied %}
                        <span class="mt-2 inline-block px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                            ‚úì Replied
                        </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar (1/3) -->
        <div class="space-y-6">
            <!-- Contact Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Contact Info</h2>
                <div class="space-y-3 text-sm">
                    {% if lead.email %}
                    <div>
                        <span class="text-gray-600">Email:</span>
                        <a href="mailto:{{ lead.email }}" class="block text-blue-600 hover:underline">
                            {{ lead.email }}
                        </a>
                    </div>
                    {% endif %}

                    {% if lead.phone %}
                    <div>
                        <span class="text-gray-600">Phone:</span>
                        <a href="tel:{{ lead.phone }}" class="block text-blue-600 hover:underline">
                            {{ lead.phone }}
                        </a>
                    </div>
                    {% endif %}

                    {% if lead.location %}
                    <div>
                        <span class="text-gray-600">Location:</span>
                        <p class="text-gray-900">{{ lead.location }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Activity Timeline</h2>
                <div class="space-y-3">
                    {% for history in status_history %}
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 mt-1.5 bg-blue-500 rounded-full"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-900">
                                Status: <span class="font-semibold">{{ history.old_status or 'none' }}</span>
                                ‚Üí <span class="font-semibold">{{ history.new_status }}</span>
                            </p>
                            <p class="text-xs text-gray-500">{{ history.changed_at.strftime('%b %d, %Y %H:%M') }}</p>
                            {% if history.notes %}
                            <p class="text-xs text-gray-600 mt-1">{{ history.notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tags -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Tags</h2>
                {% if tags %}
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for tag in tags %}
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm">
                        #{{ tag }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                <form hx-post="/leads/{{ lead.id }}/tag"
                      hx-swap="none"
                      hx-on::after-request="window.location.reload()"
                      class="flex space-x-2">
                    <input type="text"
                           name="tag"
                           placeholder="Add tag..."
                           class="flex-1 px-3 py-1 border border-gray-300 rounded text-sm">
                    <button type="submit"
                            class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                        Add
                    </button>
                </form>
            </div>

            <!-- Danger Zone -->
            <div class="bg-white rounded-lg shadow p-6 border border-red-200">
                <h2 class="text-lg font-bold text-red-600 mb-4">Danger Zone</h2>
                <button
                    hx-delete="/leads/{{ lead.id }}"
                    hx-confirm="Are you sure you want to delete this lead? This action cannot be undone."
                    hx-on::after-request="window.location.href='/leads'"
                    class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Delete Lead
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
